<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}"
      th:with="page='elabora-spedizione'">

<body>
<section layout:fragment="content">

    <style>
        /* Regole valide solo per smartphone (schermi sotto i 768px) */
        @media (max-width: 767px) {
            
            /* Impila gli elementi verticalmente */
            .input-group-mobile-stack {
                flex-direction: column !important;
            }

            /* Stile per la parte grigia (prefisso link) */
            .input-group-mobile-stack #prefissoCorriere {
                width: 100% !important;   /* FORZA LARGHEZZA PIENA */
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                text-align: left;
                
                /* Sistema i bordi per l'impilamento */
                border-radius: 0.375rem 0.375rem 0 0 !important; 
                border-right: 1px solid #dee2e6 !important; 
                
                /* Spazio per la barra di scorrimento */
                padding-bottom: 12px !important; 
            }

            /* Stile per l'input bianco (codice) */
            .input-group-mobile-stack #codiceInput {
                width: 100% !important;   /* CORREZIONE: FORZA LARGHEZZA PIENA ANCHE QUI */
                display: block !important;
                
                border-radius: 0 0 0.375rem 0.375rem !important; /* Arrotonda solo sotto */
                margin-left: 0 !important;
                border-top: 0; /* Toglie il doppio bordo */
            }
        }
    </style>
    
    <div class="row justify-content-center">
        <div class="col-md-8 content-card">

            <div class="d-flex justify-content-start mb-4">
                <a th:href="@{'/corrieri/consegne-da-elaborare'(idCampagna=${prenotazione.campagna.id})}"
                   class="btn btn-secondary">←</a>
            </div>

            <div class="mb-4" style="border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                <p><strong>Campagna:</strong> <span th:text="${prenotazione.campagna.descrizioneCampagna}"></span></p>
                <p><strong>Prodotto:</strong> <span th:text="${prenotazione.prodotto.descrizioneProdotto}"></span></p>
                <p><strong>Quantità:</strong> <span th:text="${prenotazione.quantita}"></span></p>
                <p><strong>Cliente:</strong> <span th:text="${prenotazione.cliente.nominativo}"></span></p>
            </div>

            <form th:action="@{'/corrieri/elabora-spedizione/' + ${prenotazione.id}}" method="post" onsubmit="return costruisciLink()">
                <input type="hidden" id="tracciamentoSpedizione" name="tracciamentoSpedizione">

                <div class="mb-3">
                    <label for="corriereSelect" class="form-label">Corriere</label>
                    <select id="corriereSelect" class="form-select" onchange="aggiornaInputCorriere()">
                        <option value="SDA" selected>SDA (Poste)</option>
                        <option value="TNT">TNT</option>
                        <option value="ALTRO">Altro (Link intero)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="codiceInput" class="form-label">Codice Tracciamento / Link</label>
                    
                    <div class="input-group input-group-mobile-stack">
                        <span class="input-group-text" id="prefissoCorriere"></span>
                        <input type="text" class="form-control" id="codiceInput" required>
                    </div>
                </div>

                <div class="text-center mt-4"> 
                    <button type="submit" class="btn btn-success btn-lg px-4">Salva e invia email</button>
                </div>
            </form>

        </div> 
    </div> 
        
    <script>
        const prefissi = {
            'SDA': 'https://www.poste.it/cerca/index.html#/risultati-spedizioni/',
            'TNT': 'https://www.tnt.it/tracking/getTrack.html?wt=1&consigNos=',
            'ALTRO': ''
        };

        function aggiornaInputCorriere() {
            const corriere = document.getElementById('corriereSelect').value;
            const prefissoSpan = document.getElementById('prefissoCorriere');
            const codiceInput = document.getElementById('codiceInput');

            if (corriere === 'ALTRO') {
                prefissoSpan.style.display = 'none';
                codiceInput.placeholder = 'Inserisci il link di tracciamento intero';
            } else {
                prefissoSpan.style.display = 'block';
                prefissoSpan.textContent = prefissi[corriere];
                codiceInput.placeholder = 'Inserisci solo il codice';
            }
        }

        function costruisciLink() {
            const corriere = document.getElementById('corriereSelect').value;
            const codice = document.getElementById('codiceInput').value;
            const campoNascosto = document.getElementById('tracciamentoSpedizione');
            
            if (!codice || codice.trim() === '') {
                alert('Il campo "Codice Tracciamento / Link" non può essere vuoto.');
                return false; 
            }

            if (corriere === 'ALTRO') {
                campoNascosto.value = codice;
            } else {
                campoNascosto.value = prefissi[corriere] + codice;
            }
            
            console.log("Link finale inviato:", campoNascosto.value);
            return true;
        }

        document.addEventListener('DOMContentLoaded', aggiornaInputCorriere);
    </script>
        
</section>
        
</body>
</html>